<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Notification and Display</title>
</head>
<body>
  <h1>Last Image Sent as Notification:</h1>
  <button id="toggleNotifications">Disable Notifications</button>
  <img id="lastImage" src="" alt="Last notification image will appear here" style="max-width: 100%; height: auto;"/>

  <script>
    let notificationsEnabled = true;
    const images = [];
    let page = 1;
    let worker;

    document.getElementById("toggleNotifications").addEventListener("click", function () {
      notificationsEnabled = !notificationsEnabled;
      this.innerText = notificationsEnabled ? 'Disable Notifications' : 'Enable Notifications';
    });

    async function requestNotificationPermission() {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        console.log("Notification permission denied.");
        notificationsEnabled = false;
        document.getElementById("toggleNotifications").innerText = 'Enable Notifications';
      } else {
        console.log("Notification permission granted.");
      }
    }

    function shuffle(array) {
      let currentIndex = array.length;
      while (currentIndex !== 0) {
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }
    }

    async function fetchImages() {
      const res = await fetch(`https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&json=1&tags=sort:random+kindred+-animated&pid=${page}`);
      let json = await res.json();
      json = json.filter((x) => !x.file_url.includes('mp4'));
      if (!json.length) return await fetchImages();
      images.push(...json);
      page++;
    }

async function ping() {
  if (images.length < 100) {
    await fetchImages();
  }
  shuffle(images);
  const imgData = images.shift();
  const imgUrl = imgData.file_url;
  const postUrl = `https://rule34.xxx/index.php?page=post&s=view&id=${imgData.id}`; // Create the post URL

  const url = 'https://corsproxy.io/?' + encodeURIComponent(imgUrl);
  const res = await fetch(url);
  const icon = await res.blob();
  const imageURL = URL.createObjectURL(icon);

  if (notificationsEnabled && Notification.permission === "granted") {
    navigator.serviceWorker.ready.then(function(registration) {
      registration.showNotification('New Image Available!', {
        body: 'Check out the latest image!',
        icon: 'icon.png',
        image: imageURL,
        data: {
          url: postUrl // Pass the post URL for click handling
        }
      });
    });
  }

  document.getElementById('lastImage').src = imageURL;
}

    function startWorker() {
      if (typeof Worker !== "undefined") {
        if (worker == undefined) {
          worker = new Worker('worker.js'); // Web Worker for 10-second interval
        }
        worker.postMessage({ command: 'start', interval: 10000 });

        worker.onmessage = function (e) {
          if (e.data === 'ping') {
            ping();
          }
        };
      } else {
        console.log("Web Workers are not supported in this browser.");
      }
    }

    function stopWorker() {
      if (worker) {
        worker.postMessage({ command: 'stop' });
      }
    }

    // Request notification permission on page load
    requestNotificationPermission();

    // Register service worker for background notifications
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(function(registration) {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(function(error) {
          console.error('Service Worker registration failed:', error);
        });
    }

    // Start the Web Worker for the 10-second ping
    startWorker();

    // Ensure the worker is stopped when the page is closed
    window.onbeforeunload = function () {
      stopWorker();
    };
  </script>
</body>
</html>
