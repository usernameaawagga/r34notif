<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Notification and Display</title>
</head>
<body>
  <h1>Last Image Sent as Notification:</h1>
  <button id="toggleNotifications">Disable Notifications</button>
  <!-- Image container where the last image will be displayed -->
  <img id="lastImage" src="" alt="Last notification image will appear here" style="max-width: 100%; height: auto;"/>

  <script>
    let notificationsEnabled = true; // Flag to enable or disable notifications
    let timerId; // To store the interval ID

    document.getElementById("toggleNotifications").addEventListener("click", function() {
      notificationsEnabled = !notificationsEnabled; // Toggle the flag
      this.innerText = notificationsEnabled ? 'Disable Notifications' : 'Enable Notifications'; // Update button text
    });

    async function requestNotificationPermission() {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        console.log("Notification permission denied.");
        notificationsEnabled = false;
        document.getElementById("toggleNotifications").innerText = 'Enable Notifications';
      } else {
        console.log("Notification permission granted.");
      }
    }

    function shuffle(array) {
      let currentIndex = array.length;
      while (currentIndex != 0) {
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }
    }

    const images = [];
    let page = 1;

    async function fetchImages() {
      const res = await fetch(`https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&json=1&tags=sort:random+kindred+gif&pid=${page}`);
      let json = await res.json();
      // Only filter out videos, but no more ratio restriction
      json = json.filter((x) => !x.file_url.includes('mp4'));
      if (!json.length) return await fetchImages();
      images.push(...json.map((x) => x.file_url));
      page++;
    }

    async function ping() {
      if (images.length < 100) {
        await fetchImages();
      }
      shuffle(images);
      const img = images.shift();
      const url = 'https://corsproxy.io/?' + encodeURIComponent(img);
      const res = await fetch(url);
      const icon = await res.blob();
      const imageURL = URL.createObjectURL(icon);

      // Only send a notification if notificationsEnabled is true and permission was granted
      if (notificationsEnabled && Notification.permission === "granted") {
        new Notification('', {
          image: imageURL,
        });
      }

      // Update the image on the web page
      document.getElementById('lastImage').src = imageURL;
    }

    // Start notifications with a fixed interval
    function startPingInterval() {
      ping(); // Call immediately
      timerId = setInterval(ping, 20000); // Set interval for every 20 seconds
    }

    // Clear the interval when the page is hidden
    function stopPingInterval() {
      clearInterval(timerId);
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        console.log("Page is visible again, resuming notifications...");
        startPingInterval(); // Resume the notifications
      } else {
        console.log("Page is hidden, stopping notifications...");
        stopPingInterval(); // Stop notifications
      }
    });

    // Request notification permission on page load
    requestNotificationPermission();

    // Start the initial notifications
    startPingInterval();
  </script>
</body>
</html>
