<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customizable Image Notifications</title>
  <style>
    #intervalInput {
      width: 60px;
    }

    #lastImage {
      max-width: 100%;
      height: auto;
      max-height: 500px;
    }
  </style>
</head>

<body>
  <button id="toggleNotifications">Request Permission</button>

  <div>
    <label for="tagInput">Enter Tags:</label>
    <input type="text" id="tagInput" placeholder="-ai_generated score:>=10" />
    <button id="updateTags">Update Tags</button>
  </div>

  <p>Current Tags: <span id="currentTags">None</span></p>

  <div>
    <label for="intervalInput">Set interval in seconds (Default: 10):</label>
    <input type="number" id="intervalInput" placeholder="10" min="1" />
    <button id="updateInterval">Update Interval</button>
    <p>Current Interval: <span id="currentInterval">10</span> seconds</p>
  </div>

  <button id="forceImageButton">Force image</button>
  <img id="lastImage" src="" alt="Last image will appear here" />

  <script>
    let notificationsEnabled = false;
    let tags = ""; // Initially empty
    const impliedTags = "-fart* -scat -watersports* -diaper* -pee* -poop -multi*breast* -feces* sort:random";
    let images = [];
    let page = 1;
    let interval = 10000;
    let isProcessing = false;

    function updateDisplayedTags() {
      const displayTags = tags.trim() ? `${tags}` : "None";
      document.getElementById('currentTags').innerText = displayTags;
    }

    function updateDisplayedInterval() {
      document.getElementById('currentInterval').innerText = interval / 1000;
    }

    async function requestNotificationPermission() {
      if (Notification.permission === "default") {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          console.log("Notification permission denied.");
          return false;
        }
      }
      return true;
    }

    document.getElementById("toggleNotifications").addEventListener("click", async function () {
      const granted = await requestNotificationPermission();
      if (!granted) return;

      notificationsEnabled = !notificationsEnabled;
      this.innerText = notificationsEnabled ? 'Disable' : 'Request Permission';
    });

    document.getElementById("updateTags").addEventListener("click", function () {
      tags = document.getElementById("tagInput").value.trim() || "";
      images = [];
      page = 1;
      updateDisplayedTags();
      console.log("Tags updated to:", tags);
    });

    document.getElementById("updateInterval").addEventListener("click", function () {
      const userInterval = parseInt(document.getElementById("intervalInput").value, 10);
      if (!isNaN(userInterval) && userInterval > 0) {
        interval = userInterval * 1000;
        updateDisplayedInterval();
        console.log(`Interval updated to: ${userInterval} seconds`);
      } else {
        alert("Please enter a valid interval in seconds.");
      }
    });

    async function fetchImages() {
      const apiUrl = `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&json=1&tags=${encodeURIComponent(tags)}+${encodeURIComponent(impliedTags)}&pid=${page}`;
      try {
        const res = await fetch(apiUrl);
        if (!res.ok) {
          console.error(`Failed to fetch images. HTTP status: ${res.status}`);
          return;
        }
        const json = await res.json();
        const validImages = json.filter((x) => x.file_url && !x.file_url.includes('mp4'));
        if (validImages.length === 0) {
          console.log("No valid images found. Incrementing page...");
          page++;
          return await fetchImages();
        }
        images.push(...validImages);
        page++;
      } catch (error) {
        console.error("Error fetching images:", error);
      }
    }

    async function ping() {
      if (isProcessing) return;
      isProcessing = true;

      if (images.length < 1) {
        await fetchImages();
      }

      if (images.length === 0) {
        console.log("No images available.");
        isProcessing = false;
        return;
      }

      const imgData = images.shift();
      const imgUrl = imgData.file_url;
      const postUrl = `https://rule34.xxx/index.php?page=post&s=view&id=${imgData.id}`;

      try {
        // Verify the URL is accessible
        const res = await fetch(imgUrl, { method: "HEAD" });
        if (!res.ok) {
          console.error("Image URL not accessible:", imgUrl);
          isProcessing = false;
          return;
        }

        // Assign to the image element
        document.getElementById("lastImage").src = imgUrl;

        // Show notification if enabled
        if (notificationsEnabled && Notification.permission === "granted") {
          const notification = new Notification("New Image Available", {
            body: "Click to view the image.",
            image: imgUrl,
          });
          notification.onclick = () => window.open(postUrl, "_blank");
        }
      } catch (error) {
        console.error("Error displaying image:", error);
      } finally {
        isProcessing = false;
      }
    }

    document.getElementById("forceImageButton").addEventListener("click", ping);
    updateDisplayedTags();
    updateDisplayedInterval();
  </script>
</body>

</html>
